version: "3"

vars:
  BACKEND_DIR: backend
  EXAMPLE_CLIENT_DIR: example-client-nestjs
  UI_DIR: UI

tasks:
  # Start MongoDB and run migrations, then start the backend server
  backend:
    desc: Start the backend server (MongoDB + migrations + server)
    dir: "{{.BACKEND_DIR}}"
    preconditions:
      - test -f go.mod
    cmds:
      - task: setup-db
      - echo "ğŸš€ Starting backend server..."
      - go run cmd/server/main.go

  # Setup database (MongoDB + migrations)
  setup-db:
    desc: Start MongoDB and run migrations (no auth for local dev)
    cmds:
      - echo "ğŸ“¦ Starting MongoDB..."
      - docker-compose up -d mongodb
      - echo "â³ Waiting for MongoDB to be ready..."
      - sleep 5
      - echo "ğŸ”„ Running migrations..."
      - task: migrate
      - echo "âœ… Database setup complete!"

  # Run database migrations
  migrate:
    desc: Run database migrations
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go run cmd/migrate/main.go create-collections

  # Start the NestJS example client
  example-client-nestjs:
    desc: Start the NestJS example client
    dir: "{{.EXAMPLE_CLIENT_DIR}}"
    preconditions:
      - test -f package.json
    cmds:
      - echo "ğŸš€ Starting NestJS example client..."
      - npm run start:dev

  # Start the UI
  ui:
    desc: Start the UI frontend
    dir: "{{.UI_DIR}}"
    preconditions:
      - test -f package.json
    cmds:
      - echo "ğŸš€ Starting UI..."
      - pnpm dev

  # Generate OpenAPI documentation and API client
  gen:openapi:
    desc: Generate OpenAPI documentation (backend) and TypeScript API client (frontend)
    cmds:
      - ./scripts/generate-openapi.sh

  # Cleanup: Kill all services and free ports
  cleanup:
    desc: Clean up all services and free ports
    cmds:
      - ./scripts/cleanup.sh

  # Start all services (backend, example-client-nestjs, and UI)
  up:
    desc: Start all services (backend, example-client-nestjs, and UI)
    cmds:
      - task: cleanup
      - |
        echo "ğŸš€ Starting all services..."
        PIDS=()
        task backend &
        PIDS+=($!)
        task example-client-nestjs &
        PIDS+=($!)
        task ui &
        PIDS+=($!)
        wait

  # Build and push Docker image
  build:
    desc: Build Docker image and optionally push to Docker Hub
    cmds:
      - bash scripts/build-and-push.sh {{.CLI_ARGS}}
